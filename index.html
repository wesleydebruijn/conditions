<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conditions</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      min-height: 100vh;
      padding: 40px 20px;
      font-size: 14px;
      line-height: 1.5;
    }

    .filter-builder {
      max-width: 1100px;
      margin: 0 auto;
    }

    .builder-header {
      margin-bottom: 32px;
    }

    .builder-header h2 {
      font-size: 24px;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 4px;
    }

    .builder-header p {
      color: hsl(var(--muted-foreground));
      font-size: 14px;
    }

    .builder-main-row {
      display: flex;
      align-items: flex-start;
      gap: 32px;
    }

    .panel {
      display: flex;
      flex-direction: column;
      background: transparent;
      border: none;
      box-shadow: none;
      border-radius: 0;
      padding: 0;
    }

    .panel.record {
      flex: 0 0 420px;
      position: sticky;
      align-self: flex-start;
      top: 40px;
      z-index: 1;
      min-height: 200px;
    }

    .panel.condition {
      flex: 1 1 0;
    }

    .panel label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: hsl(var(--muted-foreground));
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .panel textarea {
      width: 100%;
      min-height: 312px;
      resize: vertical;
      padding: 12px;
      font-size: 13px;
      border-radius: calc(var(--radius) - 2px);
      border: 1px solid hsl(var(--input));
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      margin-bottom: 10px;
      line-height: 1.5;
      font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', 'Menlo', monospace;
      field-sizing: content;
    }

    .panel.condition textarea {
      min-height: 370px;
      font-size: 14px;
    }

    #result-row {
      margin-top: 0;
      margin-bottom: 2px;
      min-height: 24px;
      font-size: 15px;
      text-align: right;
      font-weight: bold;
    }

    @media (max-width: 1000px) {
      .builder-main-row {
        flex-direction: column;
        gap: 20px;
      }
      .panel.record {
        position: static;
        width: 100%;
        box-shadow: none;
      }
    }
    @media (max-width: 600px) {
      .panel textarea {
        font-size: 12px;
        min-height: 200px;
      }
      .panel.condition textarea {
        min-height: 200px;
      }
    }
  </style>
</head>

<body>
  <div class="filter-builder">
    <div class="builder-header">
      <h2>Conditions</h2>
      <p>Create complex queries in JSON format that can be evaluated in front- and backend</p>
    </div>
    <div class="builder-main-row">
      <div class="panel record">
        <label for="record-input">Test</label>
        <textarea id="record-input">
{
  "coupons": ["GRATIS_AIRPODS"],
  "items": [
    {
      "name": "Apple iPhone 16",
      "type": "phone",
      "slug": "iphone-16",
      "price": 100
    },
    {
      "name": "Apple AirPods Pro",
      "type": "accessory",
      "slug": "airpods-pro",
      "price": 20
    },
    {
      "name": "Apple Watch Series 10",
      "type": "accessory",
      "slug": "watch-series-10",
      "price": 200
    }
  ]
}
        </textarea>
        <div id="result-row"><b>evaluating...</b></div>
      </div>
      <div class="panel condition">
        <label for="condition-input">Conditions</label>
        <textarea id="condition-input">
{
  "items_count": {
    "gte": 2,
    "where": {
      "type": { "eq": "accessory" }
    }
  },
  "items_price_sum": {
    "gte": 100,
    "where": {
      "type": { "eq": "phone" }
    }
  },
  "coupons": {
    "contains": ["GRATIS_AIRPODS"]
  }
}
        </textarea>
      </div>
    </div>
  </div>

  <script type="module">
    import '/src/style.css';
    import Conditions from '/src/conditions.ts';
    import Evaluator from '/src/evaluator.ts';

    const recordInput = document.getElementById('record-input');
    const conditionInput = document.getElementById('condition-input');
    const resultRow = document.getElementById('result-row');

    if(!recordInput || !conditionInput || !resultRow) throw new Error('Missing HTML Elements');

    const mapping = {
      coupons: { label: 'Coupons', type: 'text' },
      items: {
        label: 'Items',
        type: 'object',
        mapping: {
          name: { label: 'Naam', type: 'text' },
          type: { label: 'Type', type: 'text' },
          slug: { label: 'Slug', type: 'text' },
          price: { label: "Prijs", type: "number" },
        }
      }
    }

    new Conditions(conditionInput, { mapping });

    setTimeout(init, 0);

    function evaluate() {
      try {
        const condition = JSON.parse(conditionInput.value);
        const record = JSON.parse(recordInput.value);

        const match = new Evaluator(condition).match(record);

        resultRow.innerHTML = match ? 'Match ✅' : 'No Match ❌';
      } catch (err) {
        resultRow.innerHTML = `<span style="color: red">Invalid JSON</span>`;
      }
    }

    function init() {
      recordInput.addEventListener('input', () => evaluate());
      conditionInput.addEventListener('input', () => evaluate());
      conditionInput.addEventListener('change', () => evaluate());

      evaluate();
    }
  </script>
</body>
</html>